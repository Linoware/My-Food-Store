<template>
    <div :class="className" class="vue-image__container my-3" :style='{height: heightCSS}'>
        <div v-if='fallbackState.needed ? !fallbackState.loaded : !loaded'>
            <v-progress-circular v-if='mounted' indeterminate :color='this.spinnerColor' :size='spinnerSize' :width="spinnerSize / 12"></v-progress-circular>
        </div>
        <div v-else-if='!mainImageReady && !fallbackReady'>
            <v-icon :size='spinnerSize*2'>{{this.errorIcon}}</v-icon>
        </div>
        <img :src="this.src" v-show='mainImageReady' @error="handleError" @load="loaded = true">
        <img v-if='fallbackState.needed' :src="this.fallbackSrc" @error="handleFallbackError" @load="fallbackState.loaded = true">
    </div>
</template>

<script>
export default {
    name: 'v-image',
    data(){
        return {
            mounted: false,
            loaded: false,
            error: false,
            fallbackState: {
                needed: false,
                loaded: false,
                error: false
            }
        }
    },
    mounted(){
        this.mounted = true
    },
    methods: {
        handleError(){
            this.loaded = true;
            this.error = true;
            if (this.fallbackSrc) this.fallbackState.needed = true;
        },
        handleFallbackError(){
            this.fallbackState = {
                ...this.fallbackState,
                loaded: true,
                error: true
            }
        }
    },
    props: {
        src: {
            type: String,
            required: true
        },
        errorColor: {
            type: String,
            default: 'grey lighten-4'
        },
        loadingColor: {
            type: String,
            default: 'primary lighten-5'
        },
        spinnerColor: {
            type: String,
            default: 'primary lighten-1'
        },
        errorIcon: {
            type: String,
            default: 'broken_image'
        },
        aspectRatio: {
            type: String,
            default: '16:9',
            validator: e => !!e.match(/^\d+:\d+$/)
        },
        fallbackSrc: String
    },
    computed: {
        parsedAspectRatio(){
            const [, x, y] = this.aspectRatio.match(/^(\d+):(\d+)$/)

            return y/x
        },
        className(){
            return {
                [this.errorColor]: this.loaded && this.error,
                // [this.loadingColor]: !this.loaded
            }
        },
        ready(){
            return this.fallbackSrc ? this.mainImageReady || this.fallbackReady : this.mainImageReady
        },
        mainImageReady(){
            return this.loaded && !this.error
        },
        fallbackReady(){
            return this.fallbackState.loaded && !this.fallbackState.error
        },
        elementWidth(){
            return this.mounted ? this.$el.offsetWidth : 0
        },
        elementHeight(){
            return this.elementWidth * this.parsedAspectRatio
        },
        spinnerSize(){
            return Math.round(this.elementHeight / 8)
        },
        heightCSS(){
            return this.imageReady ? 'auto' : this.elementHeight + 'px'
        },
    }
}
</script>

<style lang="stylus">
.vue-image__container
    display flex
    min-height 56px
    align-items center
    justify-content center
    transition .2s cubic-bezier(.2,0,.4,1)
    transition-property background-color
    overflow hidden
    > img 
        width 100%
</style>
